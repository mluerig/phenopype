<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Example 6: Counting and measuring freshwater snails &#8212; phenopype 2.0.1 documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Example 7: Measuring worm length" href="example_7_worm_length.html" />
    <link rel="prev" title="Example 5: Stickleback morphometrics - body and armor-plate shape" href="example_5_shape_stickleback.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          phenopype</a>
        <span class="navbar-text navbar-version pull-left"><b>2.0.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="https://github.com/mluerig/phenopype">Phenopype on Github</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">Additional resources</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="tutorial_0.html">How to run tutorials and examples using Jupyter Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_1_python_intro.html">Tutorial 1: A (very) brief python introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_2_phenopype_images.html">Tutorial 2: Interacting with images in phenopype</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_3_phenopype_workflows.html">Tutorial 3: Image analysis workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_4_managing_projects.html">Tutorial 4: Setting up and managing projects</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_5_references.html">Tutorial 5: Creating and detecting a reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_6_video_analysis.html">Tutorial 6: Video analysis</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Example 6: Counting and measuring freshwater snails</a><ul>
<li><a class="reference internal" href="#Low-throughput">Low throughput</a></li>
<li><a class="reference internal" href="#High-throughput">High throughput</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="example_5_shape_stickleback.html" title="Previous Chapter: Example 5: Stickleback morphometrics - body and armor-plate shape"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Example 5: St...</span>
    </a>
  </li>
  <li>
    <a href="example_7_worm_length.html" title="Next Chapter: Example 7: Measuring worm length"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Example 7: Me... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="_sources/example_6_counting_snails.ipynb.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">Example 6: Counting and measuring freshwater snails</a><ul>
<li><a class="reference internal" href="#Low-throughput">Low throughput</a></li>
<li><a class="reference internal" href="#High-throughput">High throughput</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="body col-md-9 content" role="main">
      
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="section" id="Example-6:-Counting-and-measuring-freshwater-snails">
<h1>Example 6: Counting and measuring freshwater snails<a class="headerlink" href="#Example-6:-Counting-and-measuring-freshwater-snails" title="Permalink to this headline">¶</a></h1>
<p>In this example we will use thresholding and watershed algorithms to count freshwater snails.</p>
<div class="row; text-align: left"><div class="col-md-6"><p><img alt="Before" src="_images/ex6_before.jpg" /></p>
<p><strong>Input</strong> - Snails photographed from a camera stand. Variable brightness across the tray and snail clumping are the biggest challenges.</p>
</div><div class="col-md-6"><p><img alt="After" src="_images/ex6_after.jpg" /></p>
<p><strong>Results</strong> - After applying adaptive thresholding and a watershed algorithm, the snail separate well from the background. Now we can count them, and measure size, shape and colouration</p>
</div></div><div class="section" id="Low-throughput">
<h2>Low throughput<a class="headerlink" href="#Low-throughput" title="Permalink to this headline">¶</a></h2>
<p>First, we test a single image with the low throughput workflow.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">phenopype</span> <span class="k">as</span> <span class="nn">pp</span>
<span class="kn">import</span> <span class="nn">os</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">filepath</span> <span class="o">=</span> <span class="s2">&quot;images/snails1.jpg&quot;</span>
<span class="n">image</span><span class="p">,</span> <span class="n">img_data</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">load_image</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span>
                                <span class="n">df</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">pp</span><span class="o">.</span><span class="n">show_image</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Begin by drawing a mask around the snails inside the tray by dragging a rectangle around them - finish with <code class="docutils literal notranslate"><span class="pre">Enter</span></code>, abort with <code class="docutils literal notranslate"><span class="pre">Esc</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df_masks</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">create_mask</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
- creating mask
</pre></div></div>
</div>
<p>Now we need to measure the pixel-to-mm-ratio. The snail pictures don’t contain a scale that is appropriate for automatic detection - the millimeter-paper on the side does not contain enough unique keypoints to be detected automatically (for cases where this works see <a class="reference internal" href="example_1_detect_objects_isopods.html"><span class="doc">Example 1</span></a> and [Example 2])(example_2_landmarks_stickleback.ipynb). Therefore each image needs to be manually measured by dragging a line across the mm-paper, and entering the distance.</p>
<p><strong>Note:</strong> It is better to measure a long distance than a short distance to minimize the measurement error - use the full length (~70 mm) here.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">img_data</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">create_reference</span><span class="p">(</span><span class="n">image</span><span class="p">,</span>
                                             <span class="n">img_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
- measure pixel-to-mm-ratio
Reference set
- add column length
</pre></div></div>
</div>
<p>For high data quality it is important to verify the ID of the specimen in the current picture. Often, the picture name contains the ID, but typically an label is placed inside the image. Using the <code class="docutils literal notranslate"><span class="pre">enter_data</span></code> tool we open the image and an entry prompt that will create a column with a name of our chosing inside all exported results.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">img_data</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">preprocessing</span><span class="o">.</span><span class="n">enter_data</span><span class="p">(</span><span class="n">image</span><span class="p">,</span>
                                       <span class="n">img_data</span><span class="p">,</span>
                                       <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;ID&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
- add column ID
</pre></div></div>
</div>
<p>Next is segmentation. First we blur the image a little, convert it to a binary image, and look at the results:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">image_blurred</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">segmentation</span><span class="o">.</span><span class="n">blur</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="n">image_bin</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">segmentation</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">image_blurred</span><span class="p">,</span>
                                      <span class="n">df_masks</span><span class="o">=</span><span class="n">df_masks</span><span class="p">,</span>
                                      <span class="n">method</span><span class="o">=</span><span class="s2">&quot;adaptive&quot;</span><span class="p">,</span>
                                      <span class="n">blocksize</span><span class="o">=</span><span class="mi">59</span><span class="p">,</span> <span class="c1">## relatively low sensitivity</span>
                                      <span class="n">constant</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="c1">## constant gets subtracted from the binary result</span>
<span class="n">pp</span><span class="o">.</span><span class="n">show_image</span><span class="p">(</span><span class="n">image_bin</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
- including pixels from 1 drawn masks
</pre></div></div>
</div>
<p>The break up the clumping, we apply the watershed algorithm to the binarized image:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">image_bin</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">segmentation</span><span class="o">.</span><span class="n">watershed</span><span class="p">(</span><span class="n">image</span><span class="p">,</span>
                                      <span class="n">image_thresh</span><span class="o">=</span><span class="n">image_bin</span><span class="p">,</span>
                                      <span class="n">distance_cutoff</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span> <span class="c1"># , iterations=1, kernel_size=1</span>
<span class="n">pp</span><span class="o">.</span><span class="n">show_image</span><span class="p">(</span><span class="n">image_bin</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
- found 214 contours that match criteria
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df_contours</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">segmentation</span><span class="o">.</span><span class="n">find_contours</span><span class="p">(</span><span class="n">image_bin</span><span class="p">,</span>
                                            <span class="n">min_area</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span> <span class="c1"># needs to be &quot;child&quot; for watershed</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
- found 107 contours that match criteria
</pre></div></div>
</div>
<p>With the contours we have acquired the primary information (counts, size, area) contained in the image. However, since we have the contour location, we get the colour for free. Note that we also measure the background whiteness of each scale (<code class="docutils literal notranslate"><span class="pre">background=True</span></code>). This is important, as the snails lie across a brightness gradient within the images.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pp</span><span class="o">.</span><span class="n">measurement</span><span class="o">.</span><span class="n">colour_intensity</span><span class="p">(</span><span class="n">image</span><span class="p">,</span>
                                <span class="n">img_data</span><span class="p">,</span>
                                <span class="n">df_contours</span><span class="p">,</span>
                                <span class="n">background</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># this measures the whiteness of the area around each detected snails</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>filename</th>
      <th>width</th>
      <th>height</th>
      <th>px_mm_ratio</th>
      <th>ID</th>
      <th>contour</th>
      <th>gray_mean</th>
      <th>gray_sd</th>
      <th>gray_mean_b</th>
      <th>gray_sd_b</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>snails1.jpg</td>
      <td>2048</td>
      <td>1536</td>
      <td>8.301071</td>
      <td>163</td>
      <td>1</td>
      <td>17.473</td>
      <td>8.77379</td>
      <td>143.837</td>
      <td>36.8937</td>
    </tr>
    <tr>
      <th>1</th>
      <td>snails1.jpg</td>
      <td>2048</td>
      <td>1536</td>
      <td>8.301071</td>
      <td>163</td>
      <td>2</td>
      <td>75.2904</td>
      <td>23.4319</td>
      <td>156.452</td>
      <td>30.2478</td>
    </tr>
    <tr>
      <th>2</th>
      <td>snails1.jpg</td>
      <td>2048</td>
      <td>1536</td>
      <td>8.301071</td>
      <td>163</td>
      <td>3</td>
      <td>14.6265</td>
      <td>7.2387</td>
      <td>137.795</td>
      <td>36.1294</td>
    </tr>
    <tr>
      <th>3</th>
      <td>snails1.jpg</td>
      <td>2048</td>
      <td>1536</td>
      <td>8.301071</td>
      <td>163</td>
      <td>4</td>
      <td>32.4597</td>
      <td>18.9484</td>
      <td>160.683</td>
      <td>28.7027</td>
    </tr>
    <tr>
      <th>4</th>
      <td>snails1.jpg</td>
      <td>2048</td>
      <td>1536</td>
      <td>8.301071</td>
      <td>163</td>
      <td>5</td>
      <td>20.8357</td>
      <td>6.70049</td>
      <td>150.752</td>
      <td>36.5441</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>102</th>
      <td>snails1.jpg</td>
      <td>2048</td>
      <td>1536</td>
      <td>8.301071</td>
      <td>163</td>
      <td>103</td>
      <td>8.66171</td>
      <td>2.80216</td>
      <td>98.9212</td>
      <td>22.494</td>
    </tr>
    <tr>
      <th>103</th>
      <td>snails1.jpg</td>
      <td>2048</td>
      <td>1536</td>
      <td>8.301071</td>
      <td>163</td>
      <td>104</td>
      <td>33.8171</td>
      <td>11.4594</td>
      <td>97.1136</td>
      <td>15.8264</td>
    </tr>
    <tr>
      <th>104</th>
      <td>snails1.jpg</td>
      <td>2048</td>
      <td>1536</td>
      <td>8.301071</td>
      <td>163</td>
      <td>105</td>
      <td>11.7825</td>
      <td>4.91391</td>
      <td>92.8656</td>
      <td>20.6969</td>
    </tr>
    <tr>
      <th>105</th>
      <td>snails1.jpg</td>
      <td>2048</td>
      <td>1536</td>
      <td>8.301071</td>
      <td>163</td>
      <td>106</td>
      <td>9.56656</td>
      <td>3.64157</td>
      <td>94.618</td>
      <td>21.66</td>
    </tr>
    <tr>
      <th>106</th>
      <td>snails1.jpg</td>
      <td>2048</td>
      <td>1536</td>
      <td>8.301071</td>
      <td>163</td>
      <td>107</td>
      <td>9.02029</td>
      <td>3.80726</td>
      <td>98.5129</td>
      <td>19.3734</td>
    </tr>
  </tbody>
</table>
<p>107 rows × 10 columns</p>
</div></div>
</div>
<p>Now we draw the contours…</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">canvas</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">select_canvas</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="c1"># onto which image should the contours be draw</span>
                               <span class="n">canvas</span><span class="o">=</span><span class="s2">&quot;raw&quot;</span><span class="p">)</span> <span class="c1"># raw = original image</span>
<span class="n">canvas</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">visualization</span><span class="o">.</span><span class="n">draw_contours</span><span class="p">(</span><span class="n">canvas</span><span class="p">,</span>
                                        <span class="n">df_contours</span><span class="p">,</span>
                                        <span class="n">fill</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                        <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                        <span class="n">watershed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># this flag needs to be added when using watershedding</span>
                                        <span class="n">bounding_box</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># this indicates the area where the background was measured</span>
<span class="n">pp</span><span class="o">.</span><span class="n">show_image</span><span class="p">(</span><span class="n">canvas</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
- raw image
</pre></div></div>
</div>
<p>… and save them, as well as the masks (if we need to redo this) and the canvas for quality control.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pp</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">save_canvas</span><span class="p">(</span><span class="n">canvas</span><span class="p">,</span> <span class="n">dirpath</span><span class="o">=</span><span class="s2">&quot;_temp/output/ex6&quot;</span><span class="p">)</span>
<span class="n">pp</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">save_masks</span><span class="p">(</span><span class="n">df_masks</span><span class="p">,</span> <span class="n">dirpath</span><span class="o">=</span><span class="s2">&quot;_temp/output/ex6&quot;</span><span class="p">)</span>
<span class="n">pp</span><span class="o">.</span><span class="n">export</span><span class="o">.</span><span class="n">save_contours</span><span class="p">(</span><span class="n">df_contours</span><span class="p">,</span> <span class="n">dirpath</span><span class="o">=</span><span class="s2">&quot;_temp/output/ex6&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
- canvas saved under _temp/output/ex6\canvas.jpg (overwritten).
- masks saved under _temp/output/ex6\masks.csv (overwritten).
- contours saved under _temp/output/ex6\contours.csv (overwritten).
</pre></div></div>
</div>
<p><strong>Note:</strong> the countour csv contains only the inner, watershedded contours (separated=“child”), the outer (unseparated=“parent”) were removed with <code class="docutils literal notranslate"><span class="pre">find_contours</span></code>.</p>
</div>
<div class="section" id="High-throughput">
<h2>High throughput<a class="headerlink" href="#High-throughput" title="Permalink to this headline">¶</a></h2>
<p>As for the other examples I have created a template (<code class="docutils literal notranslate"><span class="pre">ex6</span></code>) with appropriate settings for the example. The template can be passed to the <code class="docutils literal notranslate"><span class="pre">pype</span></code> using <code class="docutils literal notranslate"><span class="pre">template=&quot;ex6&quot;</span></code> - see below.</p>
<center><div style="width:700px; text-align: justify"><p><img alt="Adding a scale" src="_images/ex6_out.jpg" /></p>
<p>Because there is a brightness gradient across the image, correcting the exposure across all images will not work. Instead we use the <code class="docutils literal notranslate"><span class="pre">colour_intensity</span></code> to return the local background whiteness (within the rectangle, excluding all snail pixels). Each snail will have an individual background brightness score that can be used to normalize the detected values, so that the colour intensity becomes a meaningful trait within and across images.</p>
</div></center><p>First, set some directories and inspect the template:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">phenopype</span> <span class="k">as</span> <span class="nn">pp</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">project_root</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;_temp/output/ex6_proj&quot;</span>
<span class="n">images</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;images&quot;</span>

<span class="n">pp</span><span class="o">.</span><span class="n">show_config_template</span><span class="p">(</span><span class="s2">&quot;ex6&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
SHOWING BUILTIN PHENOPYPE TEMPLATE ex6.yaml


- preprocessing:
  - create_mask
  - create_reference
  - enter_data
- segmentation:
  - blur:
      kernel_size: 3
  - threshold:
      method: adaptive
      blocksize: 59
      constant: 10
      channel: gray
  - watershed:
      distance_cutoff: 0.5
#     - draw  # to separate snails
  - find_contours:
      retrieval: ccomp   # needs to be ccomp for watershed
      min_diameter: 0
      min_area: 200
      subset: child   # needs to be child for watershed
- measurement:
  - colour_intensity:
      background: true
- visualization:
  - select_canvas:
      canvas: raw
  - draw_contours:
      line_width: 2
      label_width: 1
      label_size: 1
      fill: 0
      watershed: true
      bounding_box: true
  - draw_masks
- export:
  - save_contours:
      save_coords: false
  - save_colours
  - save_masks
</pre></div></div>
</div>
<p>Then create a project. As stated above in the low throughput instructions: defining a project wide scale will not work because the provided reference card is too homogeneous, i.e. does not contain enough keypoints for registration by <code class="docutils literal notranslate"><span class="pre">find_scale</span></code>. If you already have created the project, simply load it.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">project_root</span><span class="p">):</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">root_dir</span><span class="o">=</span><span class="n">project_root</span><span class="p">,</span>
                      <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">proj</span><span class="o">.</span><span class="n">add_files</span><span class="p">(</span><span class="n">image_dir</span><span class="o">=</span><span class="n">images</span><span class="p">,</span>
                   <span class="n">include</span><span class="o">=</span><span class="s2">&quot;snails&quot;</span><span class="p">,</span>
                   <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">proj</span><span class="o">.</span><span class="n">add_config</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;v1&quot;</span><span class="p">,</span>
                    <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">template</span><span class="o">=</span><span class="s2">&quot;ex6&quot;</span><span class="p">)</span>
    <span class="n">pp</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span>
                    <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">project_root</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--------------------------------------------
Project loaded from
D:\workspace\git\phenopype\tutorials\_temp\output\ex6_proj

Project has 2 image folders
--------------------------------------------
</pre></div></div>
</div>
<p>Now you can loop through all directories stored within the project object to detect the snails.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">proj</span><span class="o">.</span><span class="n">dirpaths</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">pype</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;v1&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Succesfully loaded existing pype config (pype_config_v1.yaml) from:
D:\workspace\git\phenopype\tutorials\_temp\output\ex6_proj\data\0__snails1\pype_config_v1.yaml


------------+++ new pype iteration 2021:05:10 16:11:10 +++--------------


=== AUTOLOAD ===
- columns ID from attributes.yaml
- masks_v1.csv
PREPROCESSING
create_mask
- mask with label mask1 already created (edit/overwrite=False)
create_reference
- measure pixel-to-mm-ratio
Reference set
- add column length
enter_data
- column ID already created (overwrite=False)
SEGMENTATION
blur
threshold
- including pixels from 1 drawn masks
watershed
- found 223 contours that match criteria
find_contours
- found 102 contours that match criteria
MEASUREMENT
colour_intensity
VISUALIZATION
select_canvas
- raw image
draw_contours
draw_masks
drawing mask: mask1
EXPORT
save_contours
- contours saved under D:\workspace\git\phenopype\tutorials\_temp\output\ex6_proj\data\0__snails1\contours_v1.csv (overwritten).
save_colours
- colours saved under D:\workspace\git\phenopype\tutorials\_temp\output\ex6_proj\data\0__snails1\colours_v1.csv (overwritten).
save_masks
- masks saved under D:\workspace\git\phenopype\tutorials\_temp\output\ex6_proj\data\0__snails1\masks_v1.csv (overwritten).
=== AUTOSAVE ===
save_canvas
- canvas saved under D:\workspace\git\phenopype\tutorials\_temp\output\ex6_proj\data\0__snails1\canvas_v1.jpg (overwritten).
save_data_entry
- add column ID (overwriting)


------------+++ finished pype iteration +++--------------
-------(End with Ctrl+Enter or re-run with Enter)--------




------------+++ new pype iteration 2021:05:10 16:11:25 +++--------------


Nothing loaded.
PREPROCESSING
create_mask
- mask with label mask1 already created (edit/overwrite=False)
create_reference
- measure pixel-to-mm-ratio
preprocessing.create_reference: AttributeError - &#39;_image_viewer&#39; object has no attribute &#39;reference_coords&#39;
enter_data
- column ID already created (overwrite=False)
SEGMENTATION
blur
threshold
- including pixels from 1 drawn masks
watershed
- found 223 contours that match criteria
find_contours
- found 102 contours that match criteria
MEASUREMENT
colour_intensity
VISUALIZATION
select_canvas
- raw image
draw_contours
draw_masks
drawing mask: mask1
EXPORT
save_contours
- contours saved under D:\workspace\git\phenopype\tutorials\_temp\output\ex6_proj\data\0__snails1\contours_v1.csv (overwritten).
save_colours
- colours saved under D:\workspace\git\phenopype\tutorials\_temp\output\ex6_proj\data\0__snails1\colours_v1.csv (overwritten).
save_masks
- masks saved under D:\workspace\git\phenopype\tutorials\_temp\output\ex6_proj\data\0__snails1\masks_v1.csv (overwritten).
=== AUTOSAVE ===
save_canvas
- canvas saved under D:\workspace\git\phenopype\tutorials\_temp\output\ex6_proj\data\0__snails1\canvas_v1.jpg (overwritten).
save_data_entry
- add column ID (overwriting)


------------+++ finished pype iteration +++--------------
-------(End with Ctrl+Enter or re-run with Enter)--------




TERMINATE
Succesfully loaded existing pype config (pype_config_v1.yaml) from:
D:\workspace\git\phenopype\tutorials\_temp\output\ex6_proj\data\0__snails2\pype_config_v1.yaml


------------+++ new pype iteration 2021:05:10 16:11:30 +++--------------


Nothing loaded.
PREPROCESSING
create_mask
- creating mask
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
An exception has occurred, use %tb to see the full traceback.

<span class="ansi-red-intense-fg ansi-bold">SystemExit</span><span class="ansi-red-intense-fg ansi-bold">:</span>

TERMINATE (by user)

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: To exit: use &#39;exit&#39;, &#39;quit&#39;, or Ctrl-D.
</pre></div></div>
</div>
<p>In the end, use the <code class="docutils literal notranslate"><span class="pre">collect_results</span></code> method of <code class="docutils literal notranslate"><span class="pre">proj</span></code> to save all results to a folder in the root directory.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">proj</span><span class="o">.</span><span class="n">collect_results</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span>
                     <span class="n">files</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;contours&quot;</span><span class="p">],</span>
                     <span class="n">folder</span><span class="o">=</span><span class="s2">&quot;contours_ref&quot;</span><span class="p">,</span>
                     <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Created D:\workspace\git\phenopype\tutorials\_temp\output\ex6_proj\contours_ref
[&#39;contours_v1&#39;]
Collected contours_v1.csv from 0__snails1
0__snails1_contours_v1.csv saved under D:\workspace\git\phenopype\tutorials\_temp\output\ex6_proj\contours_ref\0__snails1_contours_v1.csv.
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span>
</pre></div>
</div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2021, Moritz Lürig.<br/>
      Last updated on May 10, 2021, 5:17:54 PM.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.4.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>